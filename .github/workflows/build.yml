name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'
    
    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
    
    - name: Install dependencies
      run: go mod download
    
    - name: Run tests
      run: go test -v -race -coverprofile=coverage.out ./...
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.out
        flags: unittests
        name: codecov-umbrella

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'
    
    - name: golangci-lint
      uses: golangci/golangci-lint-action@v3
      with:
        version: latest
        args: --timeout=5m

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [test, lint]
    strategy:
      matrix:
        goos: [linux, darwin, windows]
        goarch: [amd64, arm64]
        exclude:
          # Windows ARM64 builds are not commonly needed
          - goos: windows
            goarch: arm64
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for version info
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'
    
    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
    
    - name: Install dependencies
      run: go mod download
    
    - name: Set build variables
      id: vars
      run: |
        echo "version=$(git describe --tags --always --dirty)" >> $GITHUB_OUTPUT
        echo "build_time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT
        echo "git_commit=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
    
    - name: Build binary
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
        VERSION: ${{ steps.vars.outputs.version }}
        BUILD_TIME: ${{ steps.vars.outputs.build_time }}
        GIT_COMMIT: ${{ steps.vars.outputs.git_commit }}
      run: |
        mkdir -p dist
        output_name="tf-safe-${GOOS}-${GOARCH}"
        if [ "$GOOS" = "windows" ]; then
          output_name="${output_name}.exe"
        fi
        
        go build \
          -ldflags "-s -w -X main.Version=${VERSION} -X main.BuildTime=${BUILD_TIME} -X main.GitCommit=${GIT_COMMIT}" \
          -o "dist/${output_name}" \
          .
    
    - name: Check binary size
      run: |
        for file in dist/*; do
          size=$(stat -c%s "$file")
          size_mb=$(echo "scale=2; $size/1024/1024" | bc -l)
          echo "$file: ${size_mb}MB"
          if [ $size -gt 15728640 ]; then
            echo "ERROR: $file exceeds 15MB size limit"
            exit 1
          fi
        done
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: tf-safe-${{ matrix.goos }}-${{ matrix.goarch }}
        path: dist/
        retention-days: 30